# WebSocket Client

Универсальный клиент WebSocket для использования в веб-приложениях. Позволяет создать единое WebSocket подключение и использовать его во всех скриптах веб-страницы.

## Проблема, которую решает данное решение

Когда на одной веб-странице подключены несколько JS-файлов (например, tasks.js и user-profile.js), и каждый создаёт своё WebSocket-соединение, сервер видит эти соединения как разные клиенты. Когда приходит сообщение от одного клиента, сервер рассылает его всем соединениям, включая несколько соединений от одного и того же браузера. В результате одна и та же страница получает сообщение несколько раз.

## Решение

1. Создать один общий WebSocket-клиент в отдельном файле (websocket-client.js)
2. Использовать этот общий клиент во всех JS-файлах вместо создания новых соединений
3. Внедрить систему обработчиков, чтобы разные компоненты могли подписываться на определенные типы сообщений

## Как использовать

### 1. Подключение к HTML странице

```html
<script src="websocket-client.js"></script>
<!-- Подключите другие скрипты после websocket-client.js -->
<script src="tasks.js"></script>
<script src="user-profile.js"></script>
```

### 2. Инициализация соединения

```javascript
// Настройка и инициализация соединения
WebSocketClient.init({
  url: 'ws://your-websocket-server:port', // Адрес вашего WebSocket сервера
  debug: true // Включение/выключение отладочных сообщений
});
```

### 3. Подписка на события

```javascript
// Подписка на событие соединения
WebSocketClient.on('connection', function(data) {
  if (data.status === 'connected') {
    console.log('Соединение установлено!');
  } else {
    console.log('Соединение закрыто:', data.error);
  }
});

// Подписка на получение всех сообщений
WebSocketClient.on('message', function(data) {
  console.log('Получено сообщение:', data);
});

// Подписка на конкретный тип сообщений
WebSocketClient.on('new_task', function(data) {
  console.log('Получена новая задача:', data.task);
  // Обработка новой задачи
});

// Подписка на ошибки
WebSocketClient.on('error', function(data) {
  console.error('Произошла ошибка:', data.error);
});
```

### 4. Отправка сообщений

```javascript
// Отправка JSON объекта
WebSocketClient.send({
  type: 'chat_message',
  message: 'Привет, мир!',
  timestamp: new Date().toISOString()
});

// Или отправка строки
WebSocketClient.send('Простое текстовое сообщение');
```

### 5. Управление соединением

```javascript
// Проверка состояния соединения
if (WebSocketClient.isConnected()) {
  // Соединение активно
} else {
  // Соединение не установлено
}

// Закрытие соединения
WebSocketClient.close();
```

### 6. Отмена подписки на события

```javascript
// Отмена всех подписок на конкретный тип событий
WebSocketClient.off('new_task');

// Отмена конкретной подписки (передаем ту же функцию-обработчик)
const handler = function(data) { /* ... */ };
WebSocketClient.on('new_task', handler);

// Позже, когда нужно отписаться
WebSocketClient.off('new_task', handler);
```

## Преимущества

1. **Устранение дублирования сообщений** - Единое соединение WebSocket для всей страницы
2. **Управление событиями** - Система подписки/отписки на определенные типы сообщений
3. **Автоматическое переподключение** - Автоматические попытки переподключения при потере связи
4. **Отладка** - Режим отладки для мониторинга активности WebSocket
5. **Безопасная обработка ошибок** - Ошибки в одном обработчике не влияют на другие

## Пример использования в проекте

Для примера интеграции смотрите файл `tasks.js`, где используется WebSocketClient для получения обновлений задач и комментариев. Также доступен демонстрационный файл `websocket-example.html` для тестирования клиента. 